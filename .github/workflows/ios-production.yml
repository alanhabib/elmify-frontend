name: iOS Production Build & Deploy

# ============================================================================
# WHEN THIS RUNS
# ============================================================================
# This workflow automatically builds and deploys your iOS app when:
# - Code is pushed to the 'main' branch
# - A pull request is merged to 'main'
# You can also trigger it manually from the Actions tab
on:
  push:
    branches:
      - main # active this later
  workflow_dispatch: # Allows manual trigger from GitHub UI

# ============================================================================
# WORKFLOW CONFIGURATION
# ============================================================================
jobs:
  build-ios:
    name: Build & Deploy iOS App

    # IMPORTANT: iOS apps must be built on macOS runners
    # Why: Xcode and iOS SDK are only available on macOS
    # Cost: macOS runners use 10x minutes (e.g., 10 mins = 100 mins from quota)
    runs-on: macos-15 # Latest macOS with Xcode 16+

    # Increase timeout for long builds (default is 360 mins)
    # Why: iOS builds with pods can take 15-30 minutes
    timeout-minutes: 60

    # Use secrets from "test" environment
    environment: test

    steps:
      # ========================================================================
      # STEP 1: Checkout Code
      # ========================================================================
      # Downloads your repository code to the runner
      # Why: GitHub Actions runners start empty, need your code to build
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full git history (needed for versioning)

      # ========================================================================
      # STEP 2: Setup Node.js
      # ========================================================================
      # Installs Node.js runtime environment
      # Why: Your app uses React Native/Expo which requires Node.js
      # Why: Metro bundler (JavaScript bundler) runs on Node.js
      # Why: npm/npx commands need Node.js to run
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20" # Match your local development version
          cache: "npm" # Caches node_modules to speed up future builds

      # ========================================================================
      # STEP 3: Install JavaScript Dependencies
      # ========================================================================
      # Installs all packages from package.json (React Native, Expo, etc.)
      # Why: Your app code imports these libraries
      # Why: Metro bundler needs these to create the JavaScript bundle
      # Uses 'npm ci' instead of 'npm install' for reproducible builds
      - name: Install npm Dependencies
        run: npm ci
        # Why 'npm ci':
        # - Deletes node_modules and does fresh install
        # - Uses exact versions from package-lock.json
        # - Faster and more reliable in CI environments
        # - Fails if package.json and package-lock.json are out of sync

      # ========================================================================
      # STEP 4: Setup Ruby
      # ========================================================================
      # Installs Ruby runtime (needed for CocoaPods)
      # Why: CocoaPods (iOS dependency manager) is written in Ruby
      # Why: Fastlane (deployment tool) is written in Ruby
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true # Caches Ruby gems for faster builds

      # ========================================================================
      # STEP 5: Install CocoaPods Dependencies
      # ========================================================================
      # Installs iOS native dependencies (like react-native-track-player)
      # Why: React Native bridges JavaScript to native iOS code
      # Why: Third-party native modules need to be compiled for iOS
      # Why: Creates .xcworkspace file that Xcode uses to build
      - name: Install CocoaPods
        run: |
          cd ios
          pod install
        # What this does:
        # - Reads ios/Podfile (list of dependencies)
        # - Downloads pod source code
        # - Compiles native Objective-C/Swift code
        # - Links everything into Elmify.xcworkspace

      # ========================================================================
      # STEP 6: Setup Xcode
      # ========================================================================
      # Selects the correct Xcode version
      # Why: Different Xcode versions support different iOS versions
      # Why: Ensures consistent builds across all runs
      # Why: React Native requires Xcode 16.1+
      - name: Setup Xcode
        run: sudo xcode-select --switch /Applications/Xcode_16.1.app
        # Note: Check available Xcode versions for macos-15:
        # https://github.com/actions/runner-images/blob/main/images/macos/macos-15-Readme.md

      # ========================================================================
      # STEP 7: Restore Build Cache
      # ========================================================================
      # Caches compiled code to speed up future builds
      # Why: Xcode recompiles everything by default (slow)
      # Why: DerivedData contains compiled Swift/Objective-C code
      # Why: Can reduce build time from 20 mins to 5 mins
      - name: Cache Xcode DerivedData
        uses: actions/cache@v3
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      # ========================================================================
      # STEP 8: Prepare Code Signing Files
      # ========================================================================
      # Decode certificate and provisioning profile for Fastlane
      - name: Prepare Code Signing Files
        env:
          CERTIFICATE_P12: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_P12 }}
          PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          cd ios
          echo "$CERTIFICATE_P12" | base64 --decode > certificate.p12
          echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
          echo "$APP_STORE_CONNECT_API_KEY" > AuthKey.p8

      # ========================================================================
      # STEP 9: Install Fastlane
      # ========================================================================
      - name: Install Fastlane
        run: |
          cd ios
          gem install fastlane

      # ========================================================================
      # STEP 10: Build & Upload with Fastlane
      # ========================================================================
      # Fastlane handles code signing, building, and uploading automatically
      # Why: Industry standard tool for iOS CI/CD
      # Why: Handles all the signing complexity we've been fighting
      - name: Build & Upload to TestFlight
        env:
          # Environment variables for the app
          EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          EXPO_PUBLIC_API_BASE_URL: ${{ secrets.EXPO_PUBLIC_API_BASE_URL }}
          EXPO_PUBLIC_MEDIA_BASE_URL: ${{ secrets.EXPO_PUBLIC_MEDIA_BASE_URL }}
          EXPO_PUBLIC_STREAM_BASE_URL: ${{ secrets.EXPO_PUBLIC_STREAM_BASE_URL }}
          EXPO_PUBLIC_MINIO_BASE_URL: ${{ secrets.EXPO_PUBLIC_MINIO_BASE_URL }}
          EXPO_PUBLIC_DEBUG_API: ${{ secrets.EXPO_PUBLIC_DEBUG_API }}
          EXPO_PUBLIC_ENVIRONMENT: ${{ secrets.EXPO_PUBLIC_ENVIRONMENT }}
          # Code signing secrets
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd ios
          fastlane beta

      # ========================================================================
      # STEP 11: Upload Build Artifacts
      # ========================================================================
      # Saves .ipa file to GitHub for download
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: Elmify-${{ github.sha }}.ipa
          path: ios/build/Elmify.ipa
          retention-days: 30

      # ========================================================================
      # STEP 12: Cleanup
      # ========================================================================
      # Removes sensitive files
      - name: Cleanup
        if: always()
        run: |
          cd ios
          rm -f certificate.p12 AuthKey.p8 profile.mobileprovision

# ============================================================================
# NOTIFICATIONS (Optional)
# ============================================================================
# Uncomment to get Slack/Discord/Email notifications on build status
# - uses: 8398a7/action-slack@v3
#   with:
#     status: ${{ job.status }}
#     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
#   if: always()
