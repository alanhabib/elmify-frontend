# Fastfile for Elmify iOS CI/CD

default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Setup code signing
    setup_ci

    # Import certificate into the keychain created by setup_ci
    import_certificate(
      certificate_path: "certificate.p12",
      certificate_password: ENV["IOS_CERTIFICATE_PASSWORD"],
      keychain_name: "fastlane_tmp_keychain"
    )

    # Install provisioning profile
    install_provisioning_profile(
      path: "profile.mobileprovision"
    )

    # Build the app using xcodebuild directly (skip gym's destination issues)
    archive_path = "../build/Elmify.xcarchive"

    # Archive the app
    sh("xcodebuild archive " \
       "-workspace Elmify.xcworkspace " \
       "-scheme Elmify " \
       "-configuration Release " \
       "-archivePath #{archive_path} " \
       "-allowProvisioningUpdates " \
       "PROVISIONING_PROFILE_SPECIFIER='[expo] com.elmify.app AppStore 2025-11-19T09:34:21.385Z'")

    # Export the IPA
    sh("xcodebuild -exportArchive " \
       "-archivePath #{archive_path} " \
       "-exportPath ../build " \
       "-exportOptionsPlist exportOptions.plist")

    # Rename to expected output name
    sh("mv ../build/Elmify.ipa ../build/Elmify.ipa 2>/dev/null || true")

    # Upload to TestFlight
    pilot(
      api_key_path: "AuthKey.p8",
      skip_waiting_for_build_processing: true,
      skip_submission: true
    )
  end
end
